<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–¹å½¢å¤´åƒè½¬åœ†å½¢å·¥å…· (Canvas API)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f4f7f9;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            font-size: 24px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        /* --- æ–°å¢ï¼šæ‹–æ‹½åŒºåŸŸæ ·å¼ --- */
        .upload-area {
            position: relative;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background-color: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        /* é¼ æ ‡æ‚¬åœæˆ–æ‹–æ‹½æ–‡ä»¶è¿›å…¥æ—¶çš„æ ·å¼ */
        .upload-area:hover, .upload-area.drag-over {
            border-color: #007bff;
            background-color: #eef6ff;
        }

        .upload-area p {
            margin: 0;
            font-size: 16px;
            color: #555;
            pointer-events: none; /* é˜²æ­¢æ–‡å­—é˜»æŒ¡ç‚¹å‡» */
        }
        
        .upload-area .sub-text {
            font-size: 13px;
            color: #888;
            margin-top: 5px;
        }

        /* éšè—åŸå§‹çš„æ–‡ä»¶è¾“å…¥æ¡†ï¼Œä½†è®©å®ƒè¦†ç›–æ•´ä¸ªçˆ¶å…ƒç´ ä»¥å“åº”ç‚¹å‡» */
        input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%; /* è®©æŒ‰é’®å®½åº¦å¡«æ»¡ */
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        .note {
            margin-top: 15px;
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>å¤´åƒåœ†å½¢åŒ–æ‰¹é‡å·¥å…·</h1>

    <div class="note">
        <p>âš ï¸ **åŸç†è¯´æ˜**ï¼šæœ¬å·¥å…·ä½¿ç”¨æµè§ˆå™¨ Canvas API å®ç°åœ†å½¢è£å‰ªï¼Œå¹¶å°†ç»“æœå¯¼å‡ºä¸º **PNG** æ ¼å¼ï¼ˆæ”¯æŒé€æ˜åº¦ï¼‰ã€‚</p>
    </div>

    <div id="dropZone" class="upload-area">
        <input type="file" id="imageFiles" multiple accept="image/jpeg, image/png" onchange="handleFileChange()">
        <p>ğŸ“‚ <strong>ç‚¹å‡»é€‰æ‹©</strong> æˆ– <strong>æ‹–æ‹½å›¾ç‰‡</strong> åˆ°æ­¤å¤„</p>
        <p class="sub-text">æ”¯æŒ JPG, PNG æ ¼å¼</p>
    </div>

    <button id="processBtn" onclick="startProcessing()" disabled>å¼€å§‹æ‰¹é‡è½¬æ¢å¹¶ä¸‹è½½</button>

    <div id="status">ç­‰å¾…é€‰æ‹©æ–‡ä»¶...</div>

    <canvas id="imageCanvas" style="display:none;"></canvas>
</div>

<script>
    const fileInput = document.getElementById('imageFiles');
    const processBtn = document.getElementById('processBtn');
    const statusDiv = document.getElementById('status');
    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');
    const dropZone = document.getElementById('dropZone');

    // --- 1. æ‹–æ‹½åŠŸèƒ½å®ç° ---
    
    // é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸ºï¼ˆé»˜è®¤è¡Œä¸ºé€šå¸¸æ˜¯ç›´æ¥åœ¨æµè§ˆå™¨æ‰“å¼€å›¾ç‰‡ï¼‰
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false); // é˜²æ­¢æ‹–åˆ°é¡µé¢å…¶ä»–ä½ç½®æ—¶æ‰“å¼€
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // æ·»åŠ è§†è§‰åé¦ˆï¼ˆé«˜äº®è¾¹æ¡†ï¼‰
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
    });

    // å¤„ç†æ–‡ä»¶æ”¾ç½® (Drop)
    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            // å°†æ‹–æ‹½çš„æ–‡ä»¶èµ‹å€¼ç»™ input å…ƒç´ 
            fileInput.files = files;
            // æ‰‹åŠ¨è§¦å‘çŠ¶æ€æ›´æ–°
            handleFileChange();
        }
    }

    // --- 2. åŸå§‹é€»è¾‘ä¿æŒä¸å˜ ---

    function handleFileChange() {
        const fileCount = fileInput.files.length;
        if (fileCount > 0) {
            processBtn.disabled = false;
            statusDiv.textContent = `âœ… å·²é€‰æ‹© ${fileCount} ä¸ªæ–‡ä»¶ï¼Œå‡†å¤‡å°±ç»ªã€‚`;
            processBtn.textContent = `å¼€å§‹æ‰¹é‡è½¬æ¢å¹¶ä¸‹è½½ (${fileCount})`;
        } else {
            processBtn.disabled = true;
            statusDiv.textContent = 'ç­‰å¾…é€‰æ‹©æ–‡ä»¶...';
            processBtn.textContent = 'å¼€å§‹æ‰¹é‡è½¬æ¢å¹¶ä¸‹è½½';
        }
    }

    // ä¿æŒ addEventListener ä½œä¸ºå¤‡ä»½
    fileInput.addEventListener('change', handleFileChange);

    /**
     * ä¸»æµç¨‹ï¼šå¼€å§‹æ‰¹é‡å¤„ç†
     */
    async function startProcessing() {
        const files = Array.from(fileInput.files);
        if (files.length === 0) {
            statusDiv.textContent = 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶ã€‚';
            return;
        }

        processBtn.disabled = true;
        statusDiv.textContent = `å¼€å§‹å¤„ç† ${files.length} ä¸ªæ–‡ä»¶...\n`;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const currentStatus = `[${i + 1}/${files.length}] æ­£åœ¨å¤„ç†: ${file.name}`;
            statusDiv.textContent += currentStatus + '\n';
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            statusDiv.scrollTop = statusDiv.scrollHeight;

            await processImageAndDownload(file);
            
            // ç®€å•å»¶è¿Ÿï¼Œé¿å…è¿ç»­ä¸‹è½½è§¦å‘æµè§ˆå™¨é™åˆ¶
            await new Promise(resolve => setTimeout(resolve, 100)); 
        }

        statusDiv.textContent += '\nğŸ‰ æ‰¹é‡è½¬æ¢å®Œæˆï¼è¯·æ£€æŸ¥æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹ã€‚';
        statusDiv.scrollTop = statusDiv.scrollHeight;
        processBtn.disabled = false;
    }

    /**
     * å•ä¸ªå›¾ç‰‡å¤„ç†å‡½æ•°
     */
    function processImageAndDownload(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();

            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    try {
                        const size = Math.min(img.width, img.height); 
                        const radius = size / 2;
                        
                        canvas.width = size;
                        canvas.height = size;

                        ctx.clearRect(0, 0, size, size);

                        ctx.beginPath();
                        ctx.arc(radius, radius, radius, 0, Math.PI * 2);
                        ctx.closePath();
                        ctx.clip(); 

                        const offsetX = (img.width - size) / 2;
                        const offsetY = (img.height - size) / 2;
                        
                        ctx.drawImage(img, -offsetX, -offsetY, img.width, img.height);
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                const url = URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.href = url;
                                
                                const originalName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
                                link.download = `${originalName}-circular.png`;
                                
                                document.body.appendChild(link);
                                link.click(); 
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url); 
                                
                                statusDiv.textContent += `  - ä¸‹è½½æˆåŠŸ\n`;
                                resolve();
                            } else {
                                statusDiv.textContent += `  - â— è½¬æ¢å¤±è´¥: æ— æ³•åˆ›å»º Blob å¯¹è±¡ã€‚\n`;
                                resolve(); 
                            }
                        }, 'image/png'); 

                    } catch (error) {
                        statusDiv.textContent += `  - â— å¤„ç†å¤±è´¥: ${error.message}\n`;
                        resolve();
                    }
                };
                img.onerror = () => {
                    statusDiv.textContent += `  - â— æ— æ³•åŠ è½½å›¾ç‰‡: ${file.name}\n`;
                    resolve();
                };
                img.src = e.target.result; 
            };

            reader.onerror = () => {
                statusDiv.textContent += `  - â— æ–‡ä»¶è¯»å–å¤±è´¥: ${file.name}\n`;
                resolve();
            };

            reader.readAsDataURL(file); 
        });
    }
</script>

</body>
</html>